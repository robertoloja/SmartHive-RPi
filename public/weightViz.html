<!DOCTYPE html>

<HTML>
	<HEAD>
		<TITLE></TITLE>
		<LINK REL='stylesheet' TYPE='text/css' HREF=''>
        <script src="https://apis.google.com/js/platform.js" async defer></script>
        <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
	</HEAD>
	<BODY style="margin: 0">
        <div id="chart" class="svg-container"></div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.3/d3.min.js"></script>
        <script>
    var data;
    var dKey = 'weight';
    var lineColor = 'blue';

    // Acquire data from server
    function getData(callback) {
      var request = new XMLHttpRequest();
      request.open("GET", "/data", true); // async = true
      request.onload = () => { // thus, process in a callback
          data = JSON.parse(request.responseText);

          for (var i = 0; i < data.length; i++) {
            delete data[i]['_id'];
          }
          callback(); // First render once GET is finished
          window.onresize = reRender;
      }
      request.send(null); // End GET request
    }

    getData(renderLines);
    setInterval(() => { getData(reRender) }, 1000);

    // Dataviz
    var margin = {top: 50, right: 50, bottom: 50, left: 120};
    var chartDiv = document.getElementById("chart");
    var svg; // made global, so both functions can use it

    function renderLines() {
        var w = window.innerWidth;
        var h = window.innerHeight;

        // select host svg element
        svg = d3.select(chartDiv)
                .append("svg")
                .attr('width', w - margin.right + 10)
                .attr('height', h - margin.bottom + 20)

        // Set scales. These are both also functions.
        var xScale = d3.scaleLinear()
                       .domain([0, data.length - 1])
                       .range([margin.left, w - margin.right]);

        var yScale = d3.scaleLinear()
                       .domain(d3.extent(data, (d) => d[dKey]))
                       .range([h - margin.bottom, margin.top]);

        var textScale = d3.scaleLinear()
                          .domain([0, 10])
                          .range([margin.top, h - margin.bottom]);

        // This is the function that defines the path.
        var line = d3.line()
                     .x((d, i) => xScale(i)) // foreach d in data; i is index
                     .y((d) => yScale(d[dKey])) // i is optional in callback

        // Create the path
        var lineGraph = svg.append("path")
                           .attr("d", line(data))
                           .attr("stroke", lineColor)
                           .attr("stroke-width", 1)
                           .attr("fill", "none");

        // clickable text
        var btnText = ['Weight', 'Population', 'Temperature', 'Humidity'];

        svg.append("text")
           .attr('x', 15)
           .attr('y', textScale(4))
           .attr("font-family", "sans-serif")
           .attr("font-size", "13px")
           .style('fill', 'blue')
           .on('click', () => {
             dKey = 'weight';
             lineColor = 'blue';
             reRender();
           })
           .text("Weight");

        svg.append("text")
           .attr('x', 15)
           .attr('y', textScale(5))
           .attr("font-family", "sans-serif")
           .attr("font-size", "13px")
           .style('fill', 'red')
           .on('click', () => {
             dKey = 'population';
             lineColor = 'red';
             reRender();
           })
           .text("Population");

        svg.append("text")
           .attr('x', 15)
           .attr('y', textScale(6))
           .attr("font-family", "sans-serif")
           .attr("font-size", "13px")
           .style('fill', 'green')
           .on('click', () => {
             dKey = 'temperature';
             lineColor = 'green';
             reRender();
           })
           .text("Temperature");

        svg.append('g')
           .attr("transform", "translate(0," + (h - margin.bottom) + ")")
           .call(d3.axisBottom(xScale));

        svg.append('g')
           .attr("transform", "translate(" + margin.left + ",0)")
           .call(d3.axisLeft(yScale))
    }

    function reRender() {
        svg.remove();
        renderLines();
    }
        </script>
	</BODY>
</HTML>
