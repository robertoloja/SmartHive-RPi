<!DOCTYPE html>

<HTML>
	<HEAD>
		<TITLE></TITLE>
		<LINK REL='stylesheet' TYPE='text/css' HREF=''>
        <script src="https://apis.google.com/js/platform.js" async defer></script>
        <script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
	</HEAD>
	<BODY>
        <div id="chart" class="svg-container"></div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.3/d3.min.js"></script>
        <script>
    var data;

    // Async GET request for data
    var request = new XMLHttpRequest();
    request.open("GET", "http://localhost:3000/data", true); // async = true
    request.onload = () => { // thus, process in a callback
        data = JSON.parse(request.responseText);

        for (var i = 0; i < data.length; i++) {
          delete data[i]['_id'];
          data[i]['date'] = data[i]['date']; // wat?
        }
        renderLines(); // First render once GET is finished
        window.onresize = reRender;
    }
    request.send(null); // End GET request

    // Dataviz
    var margin = {top: 10, right: 10, bottom: 10, left: 10};
    var w = window.innerWidth - margin.right - margin.left;
    var h = window.innerHeight - margin.top - margin.bottom;
    var chartDiv = document.getElementById("chart");
    var svg; // made global, so both functions can use it

    function renderLines() {
        w = window.innerWidth - margin.right - margin.left;
        h = window.innerHeight - margin.top - margin.bottom;

        svg = d3.select(chartDiv)
                .append("svg")
                .attr('width', w)
                .attr('height', h);

        var xScale = d3.scaleLinear()
                       .domain([0, data.length])
                       .range([10, w - 10])

        var yScale = d3.scaleLinear()
                       .domain(d3.extent(data, (d) => d.weight))
                       .range([h - 10, 10])

        var line = d3.line()
                     .x((d, i) => xScale(i))
                     .y((d) => yScale(d.weight))

        var lineGraph = svg.append("path")
                           .attr("d", line(data))
                           .attr("stroke", "blue")
                           .attr("stroke-width", 2)
                           .attr("fill", "none");

        text = svg.selectAll("text")
                  .data(data)
                  .enter()
                  .append("text");

        text.attr("x", (d, i) => xScale(i))
            .attr("y", (d) => yScale(d.weight) - 2)
            .attr("font-family", "sans-serif")
            .attr("font-size", "11px")
            .attr("fill", "black")
            .text((d) => d.weight);

        svg.attr('transform', 'translate(0,' + h + ')')
           .call(d3.axisBottom(xScale));
        //svg.call(d3.axisLeft(yScale));
    }

    function reRender() {
        svg.remove();
        renderLines();
    }
        </script>
	</BODY>
</HTML>
